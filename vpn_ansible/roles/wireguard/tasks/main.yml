---
- name: Create WireGuard directory
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  with_items:
    - /root/wireguard
    - /root/.wg-rest

- name: Generate WireGuard API token
  set_fact:
    api_token: "{{ wireguard_api_token }}"
  when: not api_token_hashed

- name: Stop any previous container
  command: docker stop wireguard-api
  ignore_errors: yes

- name: Remove any previous container
  command: docker rm wireguard-api
  ignore_errors: yes

- name: Run WireGuard container
  command: >
    docker run -d 
    --name wireguard-api 
    -e WG_HOST={{ ansible_host }} 
    -e AUTH_TOKEN={{ wireguard_api_token }} 
    -e ENVIRONMENT=production 
    -e WG_DEFAULT_DNS=8.8.8.8
    -v /root/.wg-rest:/etc/wireguard 
    -p {{ wireguard_port }}:51820/udp 
    -p {{ wireguard_api_port }}:3000 
    --cap-add=NET_ADMIN 
    --restart unless-stopped 
    leonovk/wg-rest-api:latest

- name: Wait for service to start
  pause:
    seconds: 15

- name: Check WireGuard API status
  uri:
    url: "http://localhost:{{ wireguard_api_port }}/healthz"
    method: GET
    status_code: 200
    timeout: 10
  register: wireguard_status
  retries: 5
  delay: 10
  until: wireguard_status.status == 200
  failed_when: false

- name: Display WireGuard API status
  debug:
    var: wireguard_status

- name: Register server details
  debug:
    msg: "WireGuard REST API started on {{ inventory_hostname }} ({{ ansible_host }})"